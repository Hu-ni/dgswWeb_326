<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comments</title>
    <script
            src="http://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
</head>
<body>
<h1>유저 목록</h1>
    <div>
        <div>
            <input type="text" id="name" placeholder="Name">
            <input type="text" id="email" placeholder="Email">
            <button onclick="addNewUser()">작성</button>
            <button onclick="listUser()">조회</button>
        </div>
        <div id="user_list"></div>
    </div>
<h1>글 목록</h1>
    <div>
        <div>
            <input type="text" id="content" placeholder="Comment">
            <button onclick="addNewComment()">작성</button>
            <button onclick="listComment()">조회</button>
        </div>
        <div id="comment_list"></div>
    </div>


<script>
    async function listUser(){
        try{
            let list = await $.get("/listUser");
            for(let i =0; i < list.length; i++){
                let user = list[i];
                $("#user_list").append(`<div id="line${user.id}" style="display: flex; border-bottom: 1px solid silver;">
                                            <div style="width: 100px;">${user.name}</div>
                                            <div style="width: 150px;">${user.email}</div>
                                            <div style="width: 150px;">${user.originalFilename}</div>
                                            <div style="width: 350px;">${user.storedPath}</div>
                                            <div>
                                                <button onclick="updateUser(this, ${user.id})">수정</button>
                                                <button onclick="removeUser(this, ${user.id})">삭제</button>
                                            </div>
                                        </div>`);
            }
        }catch(err){
            $("#user_list").html(JSON.stringify(err));
        }
    }
    async function addNewUser(){
        let user ={
            name: $("#name").val(),
            email: $("#email").val(),
        };
        try{
            let result = await $.ajax({
                url: "/addUser",
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(user)
            })

            $("#user_list").append(`<div id="line${result.id}" style="display: flex; border-bottom: 1px solid silver;">
                                            <div style="width: 100px;">${result.name}</div>
                                            <div style="width: 150px;">${result.email}</div>
                                            <div style="width: 150px;">${result.originalFilename}</div>
                                            <div style="width: 350px;">${result.storedPath}</div>
                                            <div>
                                                <button onclick="updateUser(this, ${result.id})">수정</button>
                                                <button onclick="removeUser(this, ${result.id})">삭제</button>
                                            </div>
                                            </div>`);
        }catch(err){
            $("#user_list").html(JSON.stringify(err));
        }

    }

    let name;
    let email;
    async function updateUser(btn, id){
        if($(btn).text() === "수정"){
            let line = $(`#line${id}`);
            name = line.find("div:nth-child(1)").html();
            email = line.find("div:nth-child(2)").html();
            let input_name = `<input id="modifyName${id}" value="${name}">`
            let input_email = `<input id="modifyEmail${id}" value="${email}">`
            let input_file = '<input id="upload-file" type="file">'
            line.find("div:nth-child(1)").html(input_name);
            line.find("div:nth-child(2)").html(input_email);
            line.find("div:nth-child(5)").append(input_file);
            $(btn).text("확인");
            $(btn).next().text("취소");
        }else{
            let file = $("#upload-file")[0].files[0];
            let formData = new FormData();
            formData.append('srcFile',file);
            let fileInfo = await $.ajax({
                type: "POST",
                url: '/attachment',
                data: formData,
                processData: false,
                contentType: false,
                async: false
            });

            let user ={
                name: $(`#modifyName${id}`).val(),
                email: $(`#modifyEmail${id}`).val(),
                storedPath: fileInfo.storedPath,
                originalFilename: fileInfo.originalName
            };
            let result = await $.ajax({
                type: "PUT",
                url: `/updateUser/${id}`,
                data: JSON.stringify(user),
                contentType: "application/json"
            });

            $(`#line${id}`).find("div:nth-child(1)").html(result.name);
            $(`#line${id}`).find("div:nth-child(2)").html(result.email);
            $(`#line${id}`).find("div:nth-child(3)").html(result.originalFilename);
            $(`#line${id}`).find("div:nth-child(4)").html(result.storedPath);

            $(btn).text("수정");
            $(btn).next().text("삭제");
            $("#upload-file").remove();
        }
    }

    async function removeUser(btn, id) {
        if ($(btn).text() === "삭제") {
            try {
                let result = await $.ajax({
                    type: "DELETE",
                    url: `/deleteUser/${id}`
                });

                if (result === true) $(`#line${id}`).remove();
                else alert("삭제하지 못했습니다.")
            } catch (err) {
                $("#user_list").html(JSON.stringify(err));
            }
        }else{
            $(btn).text("삭제");
            $(btn).prev().text("수정");
            $(`#line${id}`).find("div:nth-child(1)").html(name);
            $(`#line${id}`).find("div:nth-child(2)").html(email);
            $("#upload-file").remove();
        }
    }

</script>


<script>
    async function listComment() {
        try{
            let list = await $.get("/list");
            // $("#comment_list").html(JSON.stringify(list));
            for(let i =0; i < list.length; i++){
                let comment = list[i];
                $("#comment_list").append(`<div id="line${comment.id}" style="display: flex; border-bottom: 1px solid silver;">
                                        <div style="width: 150px;">${comment.username}</div>
                                        <div style="width: 350px;">${comment.content}</div>
                                        <div>
                                            <button onclick="updateComment(this, ${comment.id})">수정</button>
                                            <button onclick="removeComment(this, ${comment.id})">삭제</button>
                                        </div>
                                        </div>`);
            }
        }catch(err){
            $("#comment_list").html(JSON.stringify(err));
        }
    }

    async function addNewComment(){
        let comment ={
            userId: 1,
            content: $("#content").val()
        };
        try{
            let result = await $.ajax({
                url: "/comment",
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(comment)
            })

            $("#comment_list").append(`<div id="line${result.id}" style="display: flex; border-bottom: 1px solid silver;">
                                            <div style="width: 150px;">${result.username}</div>
                                            <div style="width: 350px;">${result.content}</div>
                                            <div>
                                                <button onclick="updateComment(this, ${result.id})">수정</button>
                                                <button onclick="removeComment(this, ${result.id})">삭제</button>
                                            </div>
                                            </div>`);
        }catch(err){
            $("#comment_list").html(JSON.stringify(err));
        }

    }

    let content = null;
    async function removeComment(btn, id) {
        if($(btn).text() === "삭제"){
            try{
                let result = await $.ajax({
                    type: "DELETE",
                    url: `/deleteComment/${id}`
                });

                if(result === true) $(`#line${id}`).remove();
                else alert("삭제하지 못했습니다.")
            }catch(err) {
                $("#comment_list").html(JSON.stringify(err));
            }
        }else{
            $(btn).text("삭제");
            $(btn).prev().text("수정");
            $(`#line${id}`).find("div:nth-child(2)").html(content);
        }

    }

    async function updateComment(btn, id){
        if($(btn).text() === "수정"){
            let line = $(`#line${id}`);
            content = line.find("div:nth-child(2)").html();
            let input = `<input id="modify${id}" value="${content}">`
            line.find("div:nth-child(2)").html(input);
            $(btn).text("확인");
            $(btn).next().text("취소");
        }else{
            let comment = {
                userId: 1,
                content: $(`#modify${id}`).val()
            };
            let result = await $.ajax({
                type: "PUT",
                url: `/updateComment/${id}`,
                data: JSON.stringify(comment),
                contentType: "application/json"
            });
            $(`#line${id}`).find("div:nth-child(2)").html(result.content);
            $(btn).text("수정");
            $(btn).next().text("삭제");
        }
    }
</script>
</body>
</html>